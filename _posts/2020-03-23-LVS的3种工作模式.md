---
layout:     post
title:      LVS的三种工作模式
subtitle:   原理及优缺点
date:       2020-03-23
author:     Derrick
header-img: img/post-bg-lvs.jpg
catalog: true
tags:
    - Linux
    - 负载均衡
---

### **LVS**的3种工作模式

#### - **`VS/NAT`**
    
#### - **`VS/TUN`**
    
#### - **`VS/DR`**









<meta name="referrer" content="no-referrer" />

***

### NAT模式（VS-NAT）

**原理**：把客户端发来的数据包的IP头的目的地址，在负载均衡器上换成其中一台RS的IP地址
并发至此RS来处理,RS处理完后把数据交给负载均衡器,负载均衡器再把数据包原IP地址改为自己的IP
将目的地址改为客户端IP地址即可期间,无论是进来的流量,还是出去的流量,都必须经过负载均衡器

**优点**：集群中的物理服务器可以使用任何支持TCP/IP操作系统，只有负载均衡器需要一个合法的IP地址

**缺点**：扩展性有限。当服务器节点（普通PC服务器）增长过多时,负载均衡器将成为整个系统的瓶颈
因为所有的请求包和应答包的流向都经过负载均衡器。当服务器节点过多时
大量的数据包都交汇在负载均衡器那，速度就会变慢！

#### `NAT方式的实现原理和数据包的改变`
![NAT](https://img-blog.csdn.net/20160319232420290)


### IP隧道模式（VS-TUN）

**原理**：首先要知道，互联网上的大多Internet服务的请求包很短小，而应答包通常很大
那么隧道模式就是，把客户端发来的数据包，封装一个新的IP头标记(仅目的IP)发给RS
RS收到后,先把数据包的头解开,还原数据包,处理后,直接返回给客户端,不需要再经过
负载均衡器。注意,由于RS需要对负载均衡器发过来的数据包进行还原,所以说必须支持
IPTUNNEL协议，所以,在RS的内核中,必须编译支持IPTUNNEL这个选项

**优点**：负载均衡器只负责将请求包分发给后端节点服务器，而RS将应答包直接发给用户
所以，减少了负载均衡器的大量数据流动，负载均衡器不再是系统的瓶颈，就能处理很巨大的请求量
这种方式，一台负载均衡器能够为很多RS进行分发。而且跑在公网上就能进行不同地域的分发。

**缺点**：隧道模式的RS节点需要合法IP，这种方式需要所有的服务器支持”IP Tunneling”
(IP Encapsulation)协议，服务器可能只局限在部分Linux系统上

#### `TUN原理和数据包的改变`
![TUN](https://img-blog.csdn.net/20160319232532978)


### 直接路由模式（VS-DR）

**原理**：负载均衡器和RS都使用同一个IP对外服务但只有DR对ARP请求进行响应
所有RS对本身这个IP的ARP请求保持静默也就是说,网关会把对这个服务IP的请求全部定向给DR
而DR收到数据包后根据调度算法,找出对应的RS,把目的MAC地址改为RS的MAC（因为IP一致）
并将请求分发给这台RS这时RS收到这个数据包,处理完成之后，由于IP一致，可以直接将数据返给客户
则等于直接从客户端收到这个数据包无异,处理后直接返回给客户端
由于负载均衡器要对二层包头进行改换,所以负载均衡器和RS之间必须在一个广播域
也可以简单的理解为在同一台交换机上

**优点**：和TUN（隧道模式）一样，负载均衡器也只是分发请求，应答包通过单独的路由方法返回给客户端
与VS-TUN相比，VS-DR这种实现方式不需要隧道结构，因此可以使用大多数操作系统做为物理服务器。

**缺点**：（不能说缺点，只能说是不足）要求负载均衡器的网卡必须与物理网卡在一个物理段上。

#### `DR的实现原理和数据包的改变`

![DR](https://img-blog.csdn.net/20160319232314633)




***
`相关参考资料`

**LVS官网**：http://www.linuxvirtualserver.org/index.html

`相关中文资料`

**LVS项目介绍**:http://www.linuxvirtualserver.org/zh/lvs1.html 

**LVS集群的体系结构**:http://www.linuxvirtualserver.org/zh/lvs2.html 

**LVS集群中的IP负载均衡技术**:http://www.linuxvirtualserver.org/zh/lvs3.html

**LVS集群的负载调度**:http://www.linuxvirtualserver.org/zh/lvs4.html 



